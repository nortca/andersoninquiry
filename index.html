<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ Inquiry Scenario Builder</title>
    
    <!-- External Libraries: React, ReactDOM, and Tailwind CSS -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF library for PDF generation -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    
    <style>
        body { font-family: 'sans-serif'; }
    </style>
</head>
<body>
    <!-- The React app will be rendered here -->
    <div id="root"></div>
    
    <script type="module">
        // --- MODULAR SDK IMPORTS (v9+) ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";

        // Make React functions available from the window object
        const { useState, useEffect, createElement, StrictMode } = window.React;
        const { createPortal } = window.ReactDOM;

        // --- Firebase Configuration ---
        // IMPORTANT: Replace this with your actual Firebase config object
        const firebaseConfig = {
          apiKey: "AIzaSyBwqmfFw8h8aA05tRGA5HuC-h0FGZ2Sb68",
          authDomain: "a-plus-inquiry-scenario-8b0c2.firebaseapp.com",
          projectId: "a-plus-inquiry-scenario-8b0c2",
          storageBucket: "a-plus-inquiry-scenario-8b0c2.firebasestorage.app",
          messagingSenderId: "383121563246",
          appId: "1:383121563246:web:f657d10d1e9dceb7c9507f",
          measurementId: "G-NT839083TS"
        };

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- App Initialization ---
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed. Make sure you have replaced the placeholder firebaseConfig.", e);
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(createElement('div', {className: 'p-4 text-center text-red-700 bg-red-100 font-bold'}, 'CRITICAL ERROR: Firebase is not configured. Please replace the placeholder firebaseConfig in the index.html file.'));
        }

        // --- Form Field Definitions ---
        const formFields = [
            { id: 'scenarioTitle', label: 'Scenario Title', type: 'text' },
            { id: 'absorb', label: 'Absorb', description: "Existing knowledge of a context is acknowledged..." },
            { id: 'ask', label: 'Ask', description: "Questions are formulated that, if answered, will help close the knowledge gap..." },
            { id: 'accumulate', label: 'Accumulate', description: "Methods are described and implemented to collect data..." },
            { id: 'access', label: 'Access', description: "Data that were accumulated are retrieved from where they are stored..." },
            { id: 'analyze', label: 'Analyze', description: "Analysis of the retrieved data is conducted..." },
            { id: 'answer', label: 'Answer', description: "Respond to the questions that were posed in the Ask stage..." },
            { id: 'announce', label: 'Announce', description: "The answers are communicated to appropriate stakeholders..." },
            { id: 'apply', label: 'Apply', description: "Decisions are made based on the answers..." },
            { id: 'comments', label: 'Comments', description: "Provide additional comments if needed." },
        ];
        const initialFormState = formFields.reduce((acc, field) => ({ ...acc, [field.id]: '' }), {});
        
        // --- UI Components ---
        const Button = ({ onClick, children, className = '', type = 'button', disabled = false }) => createElement('button', { type, onClick, className: `font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-colors duration-300 ${disabled ? 'bg-gray-400 cursor-not-allowed' : ''} ${className}`, disabled }, children);
        const LoadingSpinner = ({ message }) => createElement('div', { className: "flex justify-center items-center h-screen bg-gray-100" }, createElement('div', { className: "text-center" }, createElement('div', { className: "animate-spin rounded-full h-24 w-24 border-t-2 border-b-2 border-blue-600 mx-auto" }), createElement('h2', { className: "text-xl font-semibold mt-4 text-gray-700" }, message)));
        const DataForm = ({ onSave, initialData, onCancel, isEditMode, focusOnFieldId }) => { /* ... Unchanged ... */ };
        const InquiryDiagram = ({ item, onStageClick }) => { /* ... Unchanged ... */ };
        const HelpModal = ({ onClose }) => { /* ... Unchanged ... */ };
        const ScenarioCard = ({ item, onEdit, onDelete }) => { /* ... Unchanged ... */ };
        

        // --- Main Application Component ---
        function App() {
            const [authState, setAuthState] = useState({ user: null, loading: true, error: null });
            const [scenarios, setScenarios] = useState([]);
            const [isLoadingScenarios, setIsLoadingScenarios] = useState(true);
            const [selectedScenarioId, setSelectedScenarioId] = useState('');
            
            // Modal States
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
            const [focusOnFieldId, setFocusOnFieldId] = useState(null);

            // Effect 1: Handle Authentication
            useEffect(() => {
                if (!auth) {
                    setAuthState({ user: null, loading: false, error: "Firebase Auth not initialized." });
                    return;
                }
                const unsubscribe = onAuthStateChanged(auth, user => {
                    if (user) {
                        setAuthState({ user, loading: false, error: null });
                    } else {
                        signInAnonymously(auth).catch(e => {
                            console.error("Anonymous sign in failed", e);
                            setAuthState({ user: null, loading: false, error: "Could not connect to the database." });
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            // Effect 2: Fetch Scenarios after user is authenticated
            useEffect(() => {
                if (!authState.user) return;
                
                setIsLoadingScenarios(true);
                const dataCollectionPath = `artifacts/${appId}/users/${authState.user.uid}/submissions`;
                const q = query(collection(db, dataCollectionPath));

                const unsubscribe = onSnapshot(q, (querySnapshot) => {
                    const fetchedScenarios = querySnapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setScenarios(fetchedScenarios);
                    setIsLoadingScenarios(false);
                }, (err) => {
                    console.error("Data fetch error:", err);
                    setAuthState(prev => ({ ...prev, error: "Failed to load scenarios." }));
                    setIsLoadingScenarios(false);
                });

                return () => unsubscribe();
            }, [authState.user]);
            
            // --- Handlers (onSave, onDeleteConfirm, etc.) ---
            const handleSave = async (formData) => { /* ... Unchanged, but uses authState.user.uid ... */ };
            const handleDeleteConfirm = async () => { /* ... Unchanged, but uses authState.user.uid ... */ };
            const handleOpenFormModal = (item, stageId = null) => {
                setEditingItem(item);
                setFocusOnFieldId(stageId);
                setIsFormModalOpen(true);
            };
            const handleCloseFormModal = () => {
                setIsFormModalOpen(false);
                setEditingItem(null);
                setFocusOnFieldId(null); 
            };
            
            const selectedScenario = selectedScenarioId ? scenarios.find(s => s.id === selectedScenarioId) : null;
            
            // --- Render Logic ---
            if (authState.loading) {
                return createElement(LoadingSpinner, { message: "Connecting to the database..." });
            }
            if (authState.error) {
                return createElement('div', { className: "flex justify-center items-center h-screen bg-red-50 text-red-700 font-semibold p-4" }, authState.error);
            }

            return createElement('div', { className: "min-h-screen bg-gray-100" },
                createElement('header', { className: "bg-white shadow-sm sticky top-0 z-20" },
                    createElement('div', { className: "container mx-auto px-6 py-4 flex justify-between items-center" },
                        createElement('div', {className: "flex items-center gap-4"},
                             createElement('h1', { className: "text-2xl font-bold text-gray-800" }, "A+ Inquiry Scenario Builder"),
                             createElement('select', {
                                 className: "w-64 border border-gray-300 rounded-md py-2 px-3 text-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 truncate",
                                 value: selectedScenarioId,
                                 onChange: (e) => setSelectedScenarioId(e.target.value)
                             },
                                 createElement('option', { value: "" }, "Select a Scenario..."),
                                 ...scenarios.map(scenario => 
                                     createElement('option', { key: scenario.id, value: scenario.id }, scenario.scenarioTitle || "Untitled")
                                 )
                             )
                        ),
                        createElement('div', { className: 'flex items-center gap-2' },
                            createElement(Button, { onClick: () => handleOpenFormModal(null), className: "bg-blue-600 hover:bg-blue-700 text-white" }, "New"),
                            createElement(Button, { onClick: () => setIsHelpModalOpen(true), className: "bg-gray-200 hover:bg-gray-300 text-gray-800 p-2" }, 
                                createElement('svg', { xmlns: 'http://www.w3.org/2000/svg', className: 'h-6 w-6', fill: 'none', viewBox: '0 0 24 24', stroke: 'currentColor' },
                                    createElement('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z' })
                                )
                            )
                        )
                    )
                ),
                createElement('main', { className: "container mx-auto p-6" },
                    isLoadingScenarios
                        ? createElement(LoadingSpinner, { message: "Loading your scenarios..." })
                        : selectedScenario
                            ? createElement(ScenarioCard, { 
                                key: selectedScenario.id, 
                                item: selectedScenario,
                                onEdit: handleOpenFormModal,
                                onDelete: (id) => { setItemToDelete(id); setIsDeleteModalOpen(true); }
                             })
                             : createElement('div', { className: 'text-center text-gray-500 py-12' }, scenarios.length > 0 ? 'Select a scenario to view it.' : 'Create your first scenario by clicking "New".')
                ),
                createElement('footer', { className: "text-center py-4 text-gray-500 text-sm space-y-2" },
                    createElement('p', null, "Your User ID is: ", createElement('span', { className: "font-mono bg-gray-200 p-1 rounded text-xs" }, authState.user.uid)),
                    createElement('p', null, 
                        'Developed by Nathan C. Anderson. ', 
                        createElement('a', { 
                            href: "https://www.andersoninquiry.com/a-inquiry", 
                            target: "_blank", 
                            rel: "noopener noreferrer",
                            className: "text-blue-600 hover:underline"
                        }, 'Learn more about A+ Inquiry.')
                    )
                ),
                isFormModalOpen && createPortal( /* Form Modal */ ),
                isDeleteModalOpen && createPortal( /* Delete Modal */ ),
                isHelpModalOpen && createElement(HelpModal, { onClose: () => setIsHelpModalOpen(false) })
            );
        }
        
        // --- Render the App ---
        if (db) {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(createElement(StrictMode, null, createElement(App)));
        }

        </script>
    </body>
    </html>
