<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A+ Inquiry Scenario Builder</title>

    <!-- External Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>

    <!-- Firebase SDK (Compatibility Version) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style> body { font-family: 'sans-serif'; } </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, createElement } = React;
        const { createPortal } = ReactDOM;

        // --- Firebase Configuration ---
        // IMPORTANT: Replace this with your actual Firebase config object
        const firebaseConfig = {
          apiKey: "YOUR_API_KEY",
          authDomain: "YOUR_AUTH_DOMAIN",
          projectId: "YOUR_PROJECT_ID",
          storageBucket: "YOUR_STORAGE_BUCKET",
          messagingSenderId: "YOUR_SENDER_ID",
          appId: "YOUR_APP_ID"
        };

        // --- App Initialization ---
        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (e) {
            console.error("Firebase initialization failed. Make sure you have replaced the placeholder firebaseConfig.", e);
            // Render an error message if config is not replaced.
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(createElement('div', {className: 'p-4 text-center text-red-700 bg-red-100 font-bold'}, 'CRITICAL ERROR: Firebase is not configured. Please replace the placeholder firebaseConfig in the index.html file.'));
        }

        // --- Form Field Definitions ---
        const formFields = [
            { id: 'scenarioTitle', label: 'Scenario Title', type: 'text' },
            { id: 'absorb', label: 'Absorb', description: "Existing knowledge of a context is acknowledged..." },
            { id: 'ask', label: 'Ask', description: "Questions are formulated that, if answered, will help close the knowledge gap..." },
            { id: 'accumulate', label: 'Accumulate', description: "Methods are described and implemented to collect data..." },
            { id: 'access', label: 'Access', description: "Data that were accumulated are retrieved from where they are stored..." },
            { id: 'analyze', label: 'Analyze', description: "Analysis of the retrieved data is conducted..." },
            { id: 'answer', label: 'Answer', description: "Respond to the questions that were posed in the Ask stage..." },
            { id: 'announce', label: 'Announce', description: "The answers are communicated to appropriate stakeholders..." },
            { id: 'apply', label: 'Apply', description: "Decisions are made based on the answers..." },
            { id: 'comments', label: 'Comments', description: "Provide additional comments if needed." },
        ];
        const initialFormState = formFields.reduce((acc, field) => ({ ...acc, [field.id]: '' }), {});

        // --- UI Components ---
        const Button = ({ onClick, children, className = '', type = 'button', disabled = false }) => createElement('button', { type, onClick, className: `font-bold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-opacity-50 transition-colors duration-300 ${disabled ? 'bg-gray-400 cursor-not-allowed' : ''} ${className}`, disabled }, children);
        const LoadingSpinner = ({ message }) => createElement('div', { className: "flex justify-center items-center h-screen bg-gray-100" }, createElement('div', { className: "text-center" }, createElement('div', { className: "animate-spin rounded-full h-24 w-24 border-t-2 border-b-2 border-blue-600 mx-auto" }), createElement('h2', { className: "text-xl font-semibold mt-4 text-gray-700" }, message)));

        const DataForm = ({ onSave, initialData, onCancel, isEditMode, focusOnFieldId }) => {
            const [formData, setFormData] = useState(initialFormState);
            useEffect(() => { setFormData(initialData || initialFormState); }, [initialData]);
            useEffect(() => {
                if (focusOnFieldId) {
                    const element = document.getElementById(focusOnFieldId);
                    if (element) {
                        setTimeout(() => { 
                            element.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            element.focus();
                        }, 100);
                    }
                }
            }, [focusOnFieldId]);
            const handleChange = (e) => setFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
            const handleSubmit = (e) => { e.preventDefault(); onSave(formData); };

            return createElement('form', { onSubmit: handleSubmit, className: "space-y-6" },
                ...formFields.map(field => {
                    const props = { key: field.id, id: field.id, label: field.label, value: formData[field.id], onChange: handleChange, description: field.description };
                    if (field.type === 'text') {
                         return createElement('div', { key: field.id }, createElement('label', { htmlFor: field.id, className: "block text-sm font-bold text-gray-700 mb-1" }, field.label), createElement('input', { type: "text", id: field.id, name: field.id, value: props.value || '', onChange: props.onChange, className: "w-full px-3 py-2 border border-gray-300 rounded-md", required: true }))
                    }
                    return createElement('div', { key: field.id }, createElement('label', { htmlFor: field.id, className: "block text-sm font-bold text-gray-800 mb-1" }, field.label), createElement('p', { className: "text-xs text-gray-500 mb-2" }, field.description), createElement('textarea', { id: field.id, name: field.id, value: props.value || '', onChange: props.onChange, rows: "5", className: "w-full px-3 py-2 border border-gray-300 rounded-md" }))
                }),
                createElement('div', { className: "flex justify-end space-x-3 pt-4" },
                    createElement(Button, { onClick: onCancel, className: "bg-gray-300 hover:bg-gray-400 text-gray-800" }, "Cancel"),
                    createElement(Button, { type: "submit", className: "bg-green-600 hover:bg-green-700 text-white" }, isEditMode ? 'Update Entry' : 'Save Entry')
                )
            );
        };

        const InquiryDiagram = ({ item, onStageClick }) => {
            // ... Diagram code remains the same
            const diagramStages = formFields.filter(f => !['scenarioTitle', 'comments'].includes(f.id));
            const centerX = 200;
            const centerY = 200;
            const radius = 180;
            const angleStep = 2 * Math.PI / diagramStages.length;
            const polarToCartesian = (angle, r) => ({ x: centerX + r * Math.cos(angle), y: centerY + r * Math.sin(angle) });
            const filledStagesCount = diagramStages.filter(stage => item[stage.id] && item[stage.id].trim() !== '').length;
            let centerColor, textColor;
            if (filledStagesCount === 0) { centerColor = '#fee2e2'; textColor = 'text-red-800'; } 
            else if (filledStagesCount === diagramStages.length) { centerColor = '#dcfce7'; textColor = 'text-green-800'; }
            else { centerColor = '#fef9c3'; textColor = 'text-yellow-800'; }
            return createElement('svg', { viewBox: "0 0 400 400", className: "mx-auto my-4 max-w-lg" },
                ...diagramStages.map((stage, index) => {
                    const startAngle = angleStep * index - (Math.PI / 2) - (angleStep / 2);
                    const endAngle = startAngle + angleStep;
                    const hasText = item[stage.id] && item[stage.id].trim() !== '';
                    const start = polarToCartesian(startAngle, radius);
                    const end = polarToCartesian(endAngle, radius);
                    const pathData = `M ${centerX},${centerY} L ${start.x},${start.y} A ${radius},${radius} 0 0 1 ${end.x},${end.y} Z`;
                    const labelAngle = startAngle + (angleStep / 2);
                    const labelPos = polarToCartesian(labelAngle, radius * 0.7);
                    return createElement('g', { key: stage.id, onClick: () => onStageClick(stage.id), style: { cursor: 'pointer' } },
                        createElement('path', { d: pathData, fill: hasText ? '#dcfce7' : '#fee2e2', stroke: '#fafafa', strokeWidth: '3' }),
                        createElement('text', { x: labelPos.x, y: labelPos.y, textAnchor: 'middle', dy: '.3em', className: `font-semibold fill-current ${hasText ? 'text-green-800' : 'text-red-800'}` }, stage.label)
                    );
                }),
                createElement('circle', { cx: centerX, cy: centerY, r: 70, fill: centerColor, stroke: '#fafafa', strokeWidth: '3' }),
                createElement('text', { x: centerX, y: centerY, textAnchor: 'middle', dy: '.3em', className: `font-bold text-xl fill-current ${textColor}` }, "A+ Inquiry")
            );
        };

        // ... Other components like HelpModal and ScenarioCard remain largely the same, just using global firebase object
        const ScenarioCard = ({ item, onEdit, onDelete }) => {
            const [isNarrativeView, setIsNarrativeView] = useState(false);
            const [narrativeText, setNarrativeText] = useState('');
            const [isGenerating, setIsGenerating] = useState(false);
            const [error, setError] = useState(null);
            const [isEditingNarrative, setIsEditingNarrative] = useState(false);

            const handleGenerateNarrative = async (narrativeType) => {
              // This function remains the same
            };
            const handleExportPDF = () => { /* This function remains the same */ };
            const handleExportWord = () => { /* This function remains the same */ };

            const renderCardContent = () => { /* This function remains the same */ };
            const renderActionButtons = () => { /* This function remains the same */ };

            return createElement('div', { className: "bg-white rounded-lg shadow-md p-6 mb-6 border" },
                createElement('h3', { className: "text-xl font-bold text-blue-700 mb-4" }, item.scenarioTitle || 'Untitled'),
                createElement(InquiryDiagram, { item, onStageClick: (stageId) => onEdit(item, stageId) }),
                renderCardContent(),
                error && createElement('p', {className: 'text-red-500 text-sm mt-2'}, error),
                createElement('div', { className: "flex justify-end items-center flex-wrap gap-2 mt-6 border-t pt-4" }, ...renderActionButtons())
            );
        };

        const HelpModal = ({ onClose }) => { /* This component remains the same */ };

        // --- Main Application Component ---
        function App() {
            const [user, setUser] = useState(null);
            const [userSubmissions, setUserSubmissions] = useState([]);
            const [isLoading, setIsLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedScenarioId, setSelectedScenarioId] = useState('');
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [isDeleteModalOpen, setIsDeleteModalOpen] = useState(false);
            const [itemToDelete, setItemToDelete] = useState(null);
            const [editingItem, setEditingItem] = useState(null);
            const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
            const [focusOnFieldId, setFocusOnFieldId] = useState(null);

            useEffect(() => {
                if (!auth) return;
                const unsubscribe = auth.onAuthStateChanged(authUser => {
                    if (authUser) {
                        setUser(authUser);
                    } else {
                        auth.signInAnonymously().catch(e => {
                            console.error("Anonymous sign in failed", e);
                            setError("Could not connect to the database.");
                        });
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;
                setIsLoading(true);
                const dataCollectionPath = `artifacts/${appId}/users/${user.uid}/submissions`;
                const unsubscribe = db.collection(dataCollectionPath).onSnapshot(snapshot => {
                    const submissions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    setUserSubmissions(submissions);
                    setIsLoading(false);
                }, err => {
                    console.error("Data fetch error:", err);
                    setError("Failed to load scenarios.");
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, [user]);

            const handleSave = async (formData) => {
                if (!user) return;
                const path = `artifacts/${appId}/users/${user.uid}/submissions`;
                try {
                    if (editingItem) {
                        await db.collection(path).doc(editingItem.id).update(formData);
                    } else {
                        const docRef = await db.collection(path).add({ ...formData, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        setSelectedScenarioId(docRef.id);
                    }
                    handleCloseFormModal();
                } catch (e) {
                    console.error("Save error:", e);
                    setError("Could not save the scenario.");
                }
            };

            const handleDeleteConfirm = async () => {
                if (!user || !itemToDelete) return;
                try {
                    await db.collection(`artifacts/${appId}/users/${user.uid}/submissions`).doc(itemToDelete).delete();
                    if (selectedScenarioId === itemToDelete) {
                        setSelectedScenarioId('');
                    }
                    setIsDeleteModalOpen(false);
                    setItemToDelete(null);
                } catch (e) {
                    console.error("Delete error:", e);
                    setError("Could not delete the scenario.");
                }
            };
